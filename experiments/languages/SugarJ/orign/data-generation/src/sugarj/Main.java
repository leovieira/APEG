package sugarj;

import java.io.File;
import java.io.IOException;

import apeg.data.DataManager;
import apeg.exception.DataException;

import com.csvreader.CsvReader;

public class Main {

	private static final int NUM_EXEC=1;
	
	/**
	 * @param cmd
	 */
	public static void main(String[] cmd) throws Throwable {
		final String path = "/home/leo/workspace/APEG/experiments/languages/SugarJ/orign/case-studies";
		String project[] = {/*"closures", "pairs",*/ "xml"};
		String source[] = {"src", "src", "src"};
		String bin[] = {"bin", "bin", "bin"};
		String files[][] = {/*{"javaclosure/Test.sugj"}, {"pair/TestPair.sugj"},*/ {"xml/Test.sugj"}};
		
		String files_to_include[][] = { /*{"javaclosure/Test.sugj", "javaclosure/Syntax.sugj"},
                {"pair/TestPair.sugj", "pair/Pair.sugj"},*/
                {"xml/Test.sugj", "xml/XmlSyntax.sugj"}
              };
		
		for(int i=0; i < project.length; ++i) {
			createDir("./data/" + project[i]);
			clear(path + "/" + project[i] + "/" + bin[i]);
			for(int j = 1; j <= NUM_EXEC; ++j) {
				//clear(path + "/" + project[i] + "/" + bin[i]);
				run(path, project[i], files[i], source[i], bin[i], project[i] + "_" + j);
				clear(path + "/" + project[i] + "/" + bin[i]);
			}
			sumaryData("./data/" + project[i], project[i], files_to_include[i]);
		}
		System.exit(0);
	}

	private static void run(String path, String project, String[] files,
			                String source, String bin, String outputName) throws Throwable {
		// Generating the input arguments
		String args[] = new String[7+files.length];
		args[0] = "-l"; args[1] = "java";
		args[2] = "--sourcepath";
		//
		args[3] = path + "/" + project + "/" + source;
		args[4] = "-d";
		args[5] = path + "/" + project + "/" + bin;
		args[6] = "--gen-files";
		for(int j = 0; j < files.length; ++j) {
			args[7+j] = files[j];
		}
		apeg.data.DataManager.init(outputName, "data/" + project, false);
		org.sugarj.driver.cli.Main.main(args);
		apeg.data.DataManager.flush();
	}
	
	public static void createDir(String path) {
		File file = new File(path);
		if(!file.exists()) {
			file.mkdir();
		}
	}
	
	public static void clear(String binPath) throws IOException, InterruptedException {
		//clean the tmp files generated by sugarj
		String tmpDir = System.getProperty("java.io.tmpdir") + File.separator;
		//System.out.println(tmpDir);

		//clean the bin
		int resp = Runtime.getRuntime().exec(new String[]{"rm", "-rf", binPath}).waitFor();
		
		//clean all temp files
		String cmd = "/home/leo/workspace/APEG/experiments/languages/SugarJ/orign/data-generation/clean.sh";
		resp = Runtime.getRuntime().exec(cmd).waitFor();
		
	}
	
	private static boolean isOneOf(String file, String[] files) {
		if(file.isEmpty())
			return false;
		for(String f : files) {
			if(file.endsWith(f))
				return true;
		}
		return false;
	}
	
	private static void sumaryData(String path, String project, String[] files) throws DataException, IOException {
		DataManager.init(project + "_sumary", path, false);
		File dir = new File("data/" + project);
		int i = 1;
		for(String file : dir.list()) {
			if(file.equals(DataManager.getFileName()))
				continue;
			System.out.println(file);
			CsvReader csv = new CsvReader(dir.getAbsolutePath() + "/" + file, ';');
			csv.readHeaders(); // read the first line as header columns
			while(csv.readRecord()) {
				String file_name = csv.get("File");
				String parse_time = csv.get("Parse");
				String adapt_time = csv.get("Adapt");
				if(isOneOf(file_name, files) || file_name.equals("init")) {
					DataManager.addAdaptabilityTime("execution " + i, Long.parseLong(adapt_time));
					DataManager.addParseTime("execution " + i, Long.parseLong(parse_time));
				}				
			}
			csv.close();
			i++;
		}	
		DataManager.flush();
	}
}
